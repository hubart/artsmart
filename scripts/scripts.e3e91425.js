"use strict";angular.module("anotareApp",["ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.router","puElasticInput"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("welcome",{url:"/",templateUrl:"views/welcome.html",controller:"GalleryCtrl"}).state("signup",{url:"/signup",templateUrl:"views/signup.html",controller:"GalleryCtrl"}).state("root",{url:"/main",templateUrl:"views/root.html",controller:"AnnotationCtrl"}).state("root.explore",{url:"/explore",templateUrl:"views/explore.html",controller:"GalleryCtrl"}).state("root.annotation",{url:"/annotation",templateUrl:"views/annotation.html"})}]),angular.module("anotareApp").controller("AnnotationCtrl",["$scope","$http","AlbumService",function(a,b,c){a.imageScope,a.editMode=!1,a.annotationText="",a.comments,a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.toolIcons=[{url:"images/tool-line.png",name:"line-tool"},{url:"images/tool-square.png",name:"square-tool"},{url:"images/tool-circle.png",name:"circle-tool"},{url:"images/tool-triangle.png",name:"triangle-tool"}],a.getImage=function(b){c.getImage().then(function(c){a.imageScope=c.data.Album[0],b()},function(a){console.log("Failed to get the image, result is "+a.toString())})}}]),angular.module("anotareApp").controller("GalleryCtrl",["$scope","$http","AlbumService",function(a,b,c){a.items=[],a.imageScope=[],a.getImage=function(){c.getImage().then(function(b){a.imageScope=b.data.Album},function(a){console.log("Failed to get the image, result is "+a.toString())})}}]),angular.module("anotareApp").directive("displayAnnotation",["$timeout",function(a){return{restrict:"E",replace:!0,templateUrl:"views/display-annotation.html",link:function(b,c,d,e){function f(a){a.frame&&a.frame.remove(),a.removeSegments(),a.remove(),a=void 0,b.showAnnotation=!1,r=!1,w=!1,h=void 0,b.annotationHeader="annotation",paper.view.draw()}function g(){b.newComment="",v=!1}b.editMode=!1,b.addMode=!1,b.showAnnotation=!1,b.showDropdown=!0,s=!1,b.annotationText="",b.newComment="",b.annotationHeader="annotation";var h,i,j,k,l,m,n,o=!1,p=!0,q="",r=!1,s=!1,t=!1,u=!1,v=!1,w=!1,x={};b.imageDescription={};var y=function(){var a=$("#canvas-container");b.canvas=document.getElementById("main-canvas");var c=$("#button-column"),d=document.getElementById("canvas-image");b.imageDescription=_.pick(b.imageScope,"artist","title","description","current_location","period","year","origin_location","medium","dimensions"),d.addEventListener("load",function(){console.log("image has loaded");var d=this.naturalHeight/this.naturalWidth,e=a.width()*d;a.height(e),c.height(e),paper.setup(b.canvas),b.paper=paper,H()})},z={strokeColor:new paper.Color(.8,.9),strokeWidth:1.5,fillColor:new paper.Color(0,0,0,.2)},A={strokeColor:new paper.Color(.8,.9),strokeWidth:3.5,fillColor:new paper.Color(0,0,0,.2)},B={strokeColor:new paper.Color(.7,.1,.1,1),strokeWidth:2,fillColor:new paper.Color(0,0,0,.1)},C={strokeColor:new paper.Color(.9,.1,.1,1),strokeWidth:3,fillColor:new paper.Color(0,0,0,0)};({strokeColor:new paper.Color(0,0,1,1),strokeWidth:1}),{fillColor:new paper.Color(.2,.2,.8,1),strokeColor:new paper.Color(1,1,1,1),strokeWidth:.3};b.switchEditMode=function(){b.editMode&&r&&!b.tryDestroySelectedAnnotation()||(b.addMode&&b.switchAddMode(),b.editMode=!b.editMode,D(),b.editMode&&"undefined"==typeof h&&paper.project.getActiveLayer().children.length>1&&(h=paper.project.getActiveLayer().children[1]),"undefined"!=typeof h&&(b.editMode?h.onClick(null,"force-update"):(h.removeSegments(),h.frame.remove()),paper.view.draw()))},b.switchAddMode=function(){if(!b.editMode||!r||b.tryDestroySelectedAnnotation()){b.editMode&&(b.switchEditMode(),k.onClick()),b.addMode=!b.addMode,b.addMode||(l="");paper.project.getActiveLayer().children}};var D=function(){b.checkIsToolSelected()?$("html,body").css("cursor","crosshair"):$("html,body").css("cursor","default")};b.isEqualToToolSelected=function(a){return l===a},b.selectDrawTool=function(a){l=a,D(),"circle-tool"===a?m={type:"ellipse",comments:[]}:"square-tool"===a?m={type:"rectangle",comments:[]}:"line-tool"===a?m={type:"line",comments:[]}:"triangle-tool"===a&&(m={type:"triangle",comments:[]})};var E=function(a){k=new paper.Raster("canvas-image");var c=k.getHeight(),d=k.getWidth();j=parseFloat(b.canvas.style.height,10),i=parseFloat(b.canvas.style.width,10);var e=Math.min(j/c,i/d);k.scale(e),k.position=paper.view.center,k.type="main-image",k.onMouseEnter=function(){b.checkIsToolSelected()&&$("html,body").css("cursor","crosshair")},k.onClick=function(a){if((!r||b.tryDestroySelectedAnnotation())&&(b.safeApply(function(){b.showAnnotation=!1}),I(),g(),t=!1,u=!1,b.safeApply(function(){w=!1}),"undefined"!=typeof h&&("line"===h.type?h.style=A:h.style=z,h.active=!1,h.frame&&(h.removeSegments(),h.frame.remove())),b.checkIsToolSelected())){var c=a.point.x-b.canvas.offsetLeft,d=a.point.y-b.canvas.offsetTop;"line-tool"===l?(m.relative_x1=(c-25)/i,m.relative_y1=(d+25)/i,m.relative_x2=(c+25)/i,m.relative_y2=(d-25)/i):"triangle-tool"===l?(m.relative_x1=(c-25)/i,m.relative_y1=(d+25)/i,m.relative_x2=(c+25)/i,m.relative_y2=(d+25)/i,m.relative_x3=c/i,m.relative_y3=(d-13)/i):(m.relative_x=c/i,m.relative_y=d/j),l="",n=b.drawAnnotation(m),h=n,b.switchEditMode(),n.onClick(null,"force-update"),b.switchToEditAnnotationText(),b.safeApply(function(){r=!0,b.annotationHeader="adding new annotation",s=!1})}},a()},F=function(a,b,c){return c.subtract(a).angle-b.subtract(a).angle},G=function(a,b){var c=function(a){var b=a.bounds.clone().expand(5,5);a.frame=new paper.Path.Rectangle(b),a.frame.strokeWidth=1,a.frame.strokeColor="blue",a.frame.insert(2,new paper.Point(b.center.x,b.top)),a.frame.insert(2,new paper.Point(b.center.x,b.top-15)),a.frame.insert(2,new paper.Point(b.center.x,b.top))},d=function(a){a.frame.bottomLeftSegment=new paper.Path.Rectangle({x:a.frame.segments[0].point.x-2.5,y:a.frame.segments[0].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){b.point.y<=a.frame.segments[5].point.y+10&&(b.point.y=a.frame.segments[5].point.y+10),b.point.x>=a.frame.segments[5].point.x-10&&(b.point.x=a.frame.segments[5].point.x-10),a.bounds.setBottomLeft(b.point),G(a,"updateAll")},onMouseEnter:function(){$("html,body").css("cursor","nesw-resize")},onMouseLeave:function(){$("html,body").css("cursor","default"),$("html,body").css("cursor","default")}}),a.frame.topLeftSegment=new paper.Path.Rectangle({x:a.frame.segments[1].point.x-2.5,y:a.frame.segments[1].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){b.point.y>=a.frame.segments[6].point.y-10&&(b.point.y=a.frame.segments[6].point.y-10),b.point.x>=a.frame.segments[6].point.x-10&&(b.point.x=a.frame.segments[6].point.x-10),a.bounds.setTopLeft(b.point),G(a,"updateAll")},onMouseEnter:function(){$("html,body").css("cursor","nwse-resize")},onMouseLeave:function(){$("html,body").css("cursor","default")}}),a.frame.topRightSegment=new paper.Path.Rectangle({x:a.frame.segments[5].point.x-2.5,y:a.frame.segments[5].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){b.point.y>=a.frame.segments[0].point.y-10&&(b.point.y=a.frame.segments[0].point.y-10),b.point.x<=a.frame.segments[0].point.x+10&&(b.point.x=a.frame.segments[0].point.x+10),a.bounds.setTopRight(b.point),G(a,"updateAll")},onMouseEnter:function(){$("html,body").css("cursor","nesw-resize")},onMouseLeave:function(){$("html,body").css("cursor","default")}}),a.frame.bottomRightSegment=new paper.Path.Rectangle({x:a.frame.segments[6].point.x-2.5,y:a.frame.segments[6].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){b.point.y<=a.frame.segments[1].point.y+10&&(b.point.y=a.frame.segments[1].point.y+10),b.point.x<=a.frame.segments[1].point.x+10&&(b.point.x=a.frame.segments[1].point.x+10),a.bounds.setBottomRight(b.point),G(a,"updateAll")},onMouseEnter:function(){$("html,body").css("cursor","nwse-resize")},onMouseLeave:function(){$("html,body").css("cursor","default")}}),a.frame.rotateSegment=new paper.Path.Rectangle({x:a.frame.segments[3].point.x-2.5,y:a.frame.segments[3].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){var c=F(a.bounds.center,a.frame.segments[3].point,b.point);a.rotate(c),a.frame.rotate(c),G(a,"updateSegments"),a.frame.bottomRightSegment.rotate(c),a.frame.bottomLeftSegment.rotate(c),a.frame.topRightSegment.rotate(c),a.frame.topLeftSegment.rotate(c),a.frame.rotateSegment.rotate(c)},onMouseEnter:function(){$("html,body").css("cursor","all-scroll")},onMouseLeave:function(){$("html,body").css("cursor","default")}})},e=function(){a.frame.bottomLeftSegment.remove(),a.frame.bottomRightSegment.remove(),a.frame.topLeftSegment.remove(),a.frame.topRightSegment.remove(),a.frame.rotateSegment.remove()};a.removeSegments=e,"makeNew"===b?(c(a),d(a)):a.frame&&"updateAll"===b?(e(a),a.frame.remove(),c(a),d(a)):a.frame&&"updateSegments"===b&&(e(a),d(a))};b.drawAnnotation=function(a){var c,d=function(a){var c=function(a){b.checkIsToolSelected()||(b.editMode?$("html,body").css("cursor","move"):$("html,body").css("cursor","pointer"),t||(b.showAnnotation=!0,b.safeApply(function(){b.annotationText=a.text,b.comments=a.comments})),a.active||(a.style=B))},d=function(a){b.checkIsToolSelected()||$("html,body").css("cursor","default"),t||b.safeApply(function(){b.showAnnotation=!1}),a.active||("line"===a.type?a.style=A:a.style=z)},e=function(a,c){b.editMode&&($("html,body").css("cursor","move"),a.point.x<k.bounds.x?a.point.x=k.bounds.x:a.point.x>k.bounds.x+k.bounds.width&&(a.point.x=k.bounds.x+k.bounds.width),a.point.y<k.bounds.y?a.point.y=k.bounds.y:a.point.y>k.bounds.y+k.bounds.height&&(a.point.y=k.bounds.y+k.bounds.height),c.position=a.point,G(c,"updateAll"))},f=function(a,c,d){b.checkIsToolSelected()||r&&c!==n&&!b.tryDestroySelectedAnnotation()||("undefined"!=typeof h&&h!==c&&("line"===h.type?h.style=A:h.style=z,h.active=!1,I(),g(),b.editMode&&(h.removeSegments(),h.frame.remove())),(h!==c||"undefined"!=typeof d&&"force-update"===d)&&(b.showAnnotation=!0,b.safeApply(function(){b.annotationText=c.text,b.comments=c.comments})),b.safeApply(function(){h=c,c.active=!0,c.style=C,t=!0,u=!0,w=!0}),b.editMode&&(c.frame?G(c,"updateAll"):G(c,"makeNew")))};a.onMouseDrag=function(b){e(b,a)},a.onMouseEnter=function(){c(a)},a.onMouseLeave=function(){d(a)},a.onClick=function(b,c){return f(b,a,c),!1}},e=function(a){var b;return b="undefined"==typeof a.relative_width||"undefined"==typeof a.relative_height?new paper.Path.Rectangle({width:70,height:70,style:z}):new paper.Path.Rectangle({width:a.relative_width*i,height:a.relative_height*j,style:z})},f=function(a){var b;return b="undefined"==typeof a.relative_width||"undefined"==typeof a.relative_height?new paper.Path.Ellipse({width:70,height:70,style:z}):new paper.Path.Ellipse({width:a.relative_width*i,height:a.relative_height*j,style:z})},l=function(a){var b=new paper.Point(a.relative_x1*i,a.relative_y1*j),c=new paper.Point(a.relative_x2*i,a.relative_y2*j),d=new paper.Path.Line(b,c);return d.style=A,d},m=function(a){var b=new paper.Point(a.relative_x1*i,a.relative_y1*j),c=new paper.Point(a.relative_x2*i,a.relative_y2*j),d=new paper.Point(a.relative_x3*i,a.relative_y3*j),e=new paper.Path({segments:[b,c,d],style:z,closed:!0});return e};return"rectangle"===a.type?c=e(a):"ellipse"===a.type?c=f(a):"line"===a.type?c=l(a):"triangle"===a.type&&(c=m(a)),"undefined"!=typeof c?(c.type=a.type,_.contains(["line","triangle"],c.type)||(c.position.setX(a.relative_x*i),c.position.setY(a.relative_y*j)),c.text=a.text,c.comments=a.comments,c.active=!1,d(c),c):void console.log("Shape"+a.type+"is unidentified")};var H=function(){E(function(){b.imageScope.annotations.forEach(function(a){b.drawAnnotation(a)})})};b.shouldShowDeleteButton=function(){return w},b.switchToEditAnnotationText=function(){s=!0,q=b.annotationText,angular.element("#annotation-description > textarea").prop("disabled",!1).focus()},b.submitNewAnnotationText=function(){b.annotationText&&b.annotationText.trim().length>0?(h.text=b.annotationText,r=!1,s=!1,b.annotationHeader="annotation",b.switchEditMode()):alert("You can't submit an empty annotation.")},b.cancelEditAnnotationText=function(){s=!1,angular.element("#annotation-description > textarea").prop("disabled",!0),q.trim().length>0&&(b.annotationText=q),q=""};var I=function(){q="",b.cancelEditAnnotationText()};b.updateEditAnnotationText=function(){b.annotationText.trim().length>0?(s=!1,h.text=b.annotationText,angular.element("#annotation-description > textarea").prop("disabled",!0),q=""):alert("You can't submit an empty annotation.")},b.checkIsToolSelected=function(){return!!l},b.shouldShowSubmitAnnotation=function(){return r},b.shouldShowEditAnnotation=function(){return!s&&!r},b.shouldShowUpdateAnnotation=function(){return s},b.tryDestroySelectedAnnotation=function(){var a;return a=n===h?"Are you sure you do no want to submit your new annotation?":"Are you sure you want to delete this annotation?",confirm(a)?(f(h),!0):!1},b.shouldShowTextAnnotationTools=function(){return u},b.shouldShowAnnotationComments=function(){return u&&!r},b.shouldShowCommentTextArea=function(){return v},b.showCommentTextArea=function(){v=!0,a(function(){$(".add-comment-textarea").focus()})},b.cancelNewComment=function(){g()},b.submitNewComment=function(){"string"==typeof b.newComment&&b.newComment.trim().length>0?(h.comments.push({text:b.newComment,user:"bla"}),g()):alert("You can't submit an empty comment.")},b.shouldShowAddAComment=function(){return!v&&!r},b.shouldShowMoreInfo=function(){return!o&&p},b.shouldShowLessInfo=function(){return o&&p},b.shouldShowEditImageDescription=function(){return p},b.showMoreInfo=function(){o=!0},b.showLessInfo=function(){o=!1},b.editImageDescription=function(){x=_.clone(b.imageDescription),p=!1},b.updateImageDescription=function(){_.extendOwn(b.imageScope,b.imageDescription),p=!0},b.cancelImageDescription=function(){_.extendOwn(b.imageDescription,x),p=!0},b.shouldShowDescriptionLabels=function(){return!p},b.shouldShowMoreDescription=function(){return o},b.getImage(y)}}}]).directive("elastic",["$timeout",function(a){return{restrict:"A",require:"ngModel",link:function(b,c){var d=c.controller("ngModel"),e=function(a){if("TEXTAREA"===c.prop("tagName")){var b=c.height(1)[0].scrollHeight;c.height(b)}else console.warn("directive elastic is only for textarea element")};b.$watch(function(){return d.$modelValue+c.attr("class")},function(){a(e,0)},!1)}}}]),angular.module("anotareApp").directive("photoSlider",["$interval",function(a){return{restrict:"EA",link:function(b){b.currentIndex=0,b.loadToItem=function(){for(var a=1;5>a;a++)b.items.push(b.imageScope[a]),b.items[a-1].visible=!1;b.items[b.currentIndex].visible=!0},b.next=function(){b.items[b.currentIndex].visible=!1,b.currentIndex=b.currentIndex<b.items.length-1?b.currentIndex+1:0,b.items[b.currentIndex].visible=!0},b.prev=function(){b.items[b.currentIndex].visible=!1,b.currentIndex=b.currentIndex>0?b.currentIndex-1:b.items.length-1,b.items[b.currentIndex].visible=!0},b.setCurrentIndex=function(a){b.currentIndex=a},b.isCurrentIndex=function(a){return b.currentIndex===a},b.updateSlide=function(){"undefined"!=typeof b.items&&b.items.length>0&&(angular.forEach(b.items,function(a){a.visible=!1}),b.items[b.currentIndex].visible=!0)},b.$watch("currentIndex",function(){b.updateSlide()}),b.$watch("imageScope",function(a,c){"undefined"!=typeof a&&a.length>0&&b.loadToItem()}),b.getImage(),a(b.next,5e3)}}}]),angular.module("anotareApp").directive("parallax",function(){return{restrict:"A",replace:!0,scope:{offset:"@offsetParallax",direction:"@directionParallax"},link:function(a,b,c,d){var e=(Number(b.css("margin-top").replace(/[^-\d\.]/g,"")),Number(b.css("margin-left").replace(/[^-\d\.]/g,"")),Number(b[0].style.width.replace(/[^-\d\.]/g,""))),f=Number(b[0].style.height.replace(/[^-\d\.]/g,""));$(window).height()-f/2+10,$(window).width()-e/2}}}),angular.module("anotareApp").directive("horizontalInfinityScroll",function(){return{restrict:"EA",link:function(a,b,c){var d,e=0,f=!0,g=b[0],h=!1;a.loadMore=function(){for(var b=0;5>b&&e<a.imageScope.length;b++)a.items.push(a.imageScope[e]),e++},a.scrollRight=function(){h=!0,d=window.setInterval(function(){h&&$(g).animate({scrollLeft:"+=20"},100)},100)},a.scrollEnd=function(){window.clearInterval(d),h=!1},a.scrollLeft=function(){h=!0,d=window.setInterval(function(){h&&$(g).animate({scrollLeft:"-=20"},100)},100)},a.getImage(),a.$watch("imageScope",function(b,c){"undefined"!=typeof b&&b.length>0&&f&&(f=!1,a.loadMore())}),b.bind("scroll",function(){g.scrollLeft+g.offsetWidth>=g.scrollWidth&&a.$apply(c.horizontalInfinityScroll)})}}}),angular.module("anotareApp").factory("AlbumService",["$http",function(a){var b={getImage:function(){return a.get("data/album.json").success(function(a){return a.Album}).error(function(a,b){console.log("Oh no! An error! Error status: "+b)})}};return b}]);